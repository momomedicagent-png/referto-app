<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assistente Referti Medici</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f7fb; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    h1 { text-align: center; color: #1976d2; }
    .upload-box { border: 2px dashed #1976d2; border-radius: 8px; padding: 30px; text-align: center; color: #555; background: #fff; margin-bottom: 20px; cursor: pointer; }
    #fileList { margin: 10px 0; }
    .file-item { font-size: 14px; margin: 5px 0; }
    .preview img { max-width: 100%; margin: 10px 0; border-radius: 8px; }
    .log { background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 15px 0; font-size: 14px; max-height: 200px; overflow-y: auto; display: none; }
    .section { display: none; margin-top: 20px; }
    .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 5px; }
    .btn-primary { background: #1976d2; color: #fff; }
    .btn-secondary { background: #ccc; color: #333; }
    textarea { width: 100%; height: 80px; margin-top: 10px; }

    /* Spinner */
    .spinner {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1976d2;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 15px auto;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü©∫ Assistente Referti Medici</h1>
    <p>Carica uno o pi√π referti (PDF, immagini, DOCX, ecc.) per estrarre il testo e poi avvia l‚Äôanalisi.</p>

    <div id="uploadBox" class="upload-box">
      Clicca o trascina qui i tuoi file
      <input type="file" id="fileInput" multiple style="display:none" />
    </div>
    <div id="fileList"></div>
    <div id="preview" class="preview"></div>

    <div id="spinner" class="spinner"></div>
    <div id="logBox" class="log"></div>

    <div id="results" class="section">
      <h3>üìÑ Testo estratto</h3>
      <pre id="fullText"></pre>
      <h3>‚öôÔ∏è Scegli tipo di analisi</h3>
      <select id="promptType">
        <option value="simple">Riassunto semplice</option>
        <option value="intermediate">Analisi intermedia</option>
        <option value="detailed">Analisi dettagliata</option>
        <option value="custom">Prompt personalizzato</option>
      </select>
      <textarea id="customPrompt" placeholder="Inserisci prompt personalizzato (opzionale)"></textarea>
      <button id="analyzeBtn" class="btn btn-primary">Avvia analisi</button>
    </div>

    <div id="summarySection" class="section">
      <h3>‚úÖ Riassunto</h3>
      <pre id="summaryText"></pre>
      <button id="downloadBtn" class="btn btn-primary">Scarica Word</button>
      <button id="resetBtn" class="btn btn-secondary">Nuovo upload</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const uploadBox = document.getElementById("uploadBox");
    const fileList = document.getElementById("fileList");
    const preview = document.getElementById("preview");
    const logBox = document.getElementById("logBox");
    const resultsEl = document.getElementById("results");
    const fullTextEl = document.getElementById("fullText");
    const summaryText = document.getElementById("summaryText");
    const summarySection = document.getElementById("summarySection");
    const downloadBtn = document.getElementById("downloadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const promptType = document.getElementById("promptType");
    const customPrompt = document.getElementById("customPrompt");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const spinner = document.getElementById("spinner");

    let extractedText = "";
    let useClientOCR = false;

    // Spinner helpers
    function showSpinner() { spinner.style.display = "block"; }
    function hideSpinner() { spinner.style.display = "none"; }

    // Logging helper
    function log(msg) {
      logBox.style.display = "block";
      logBox.innerHTML += "üîπ " + msg + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
    }

    // Benchmark OCR (decide client vs server)
    async function decideOCRStrategy() {
      const start = performance.now();
      await Tesseract.recognize(new Blob(["TEST OCR"], {type:"text/plain"}), "eng");
      const time = performance.now() - start;
      useClientOCR = time < 800; // threshold
      log(`Strategia OCR: ${useClientOCR ? "Client" : "Server"}`);
    }

    // Upload Box logic
    uploadBox.addEventListener("click", () => fileInput.click());
    uploadBox.addEventListener("dragover", e => { e.preventDefault(); uploadBox.style.background="#e3f2fd"; });
    uploadBox.addEventListener("dragleave", e => { uploadBox.style.background="#fff"; });
    uploadBox.addEventListener("drop", e => { e.preventDefault(); fileInput.files = e.dataTransfer.files; handleFiles(); });
    fileInput.addEventListener("change", handleFiles);

    function handleFiles() {
      const files = fileInput.files;
      fileList.innerHTML = "";
      preview.innerHTML = "";
      extractedText = "";
      if (!files.length) return;
      [...files].forEach(file => {
        const item = document.createElement("div");
        item.className = "file-item";
        item.textContent = `${file.name} (${Math.round(file.size/1024)} KB)`;
        fileList.appendChild(item);

        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = e => {
            const img = document.createElement("img");
            img.src = e.target.result;
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
      uploadFiles(files);
    }

    // Upload to server or OCR client-side
    async function uploadFiles(files) {
      log("Caricamento file...");
      showSpinner();
      try {
        if (useClientOCR) {
          log("OCR lato client...");
          let combined = "";
          for (let file of files) {
            if (file.type.startsWith("image/")) {
              const { data: { text } } = await Tesseract.recognize(file, "ita+eng");
              combined += text + "\n";
            } else {
              const formData = new FormData();
              formData.append("file", file);
              const resp = await fetch("/upload", { method:"POST", body: formData });
              const result = await safeJson(resp, "estrazione lato server fallback");
              combined += result.full_text || "";
            }
          }
          extractedText = combined;
          fullTextEl.textContent = extractedText;
          resultsEl.style.display = "block";
        } else {
          const formData = new FormData();
          [...files].forEach(f => formData.append("file", f));
          const resp = await fetch("/upload", { method:"POST", body: formData });
          const result = await safeJson(resp, "estrazione server");
          extractedText = result.full_text;
          fullTextEl.textContent = extractedText;
          resultsEl.style.display = "block";
        }
      } catch (err) {
        log("‚ùå Errore upload: " + err.message);
      } finally {
        hideSpinner();
      }
    }

    // Analyze button
    analyzeBtn.addEventListener("click", async () => {
      if (!extractedText) {
        log("Nessun testo da analizzare.");
        return;
      }
      log("Avvio analisi...");
      showSpinner();
      try {
        const formData = new FormData();
        formData.append("extracted_text", extractedText);
        formData.append("prompt_type", promptType.value);
        formData.append("custom_prompt", customPrompt.value);

        const resp = await fetch("/analyze", { method:"POST", body: formData });
        const result = await safeJson(resp, "analisi");
        summaryText.textContent = result.summary || "Errore analisi";
        summarySection.style.display = "block";
        downloadBtn.style.display = "inline-block";
        resetBtn.style.display = "inline-block";
      } catch (err) {
        log("‚ùå Errore analisi: " + err.message);
      } finally {
        hideSpinner();
      }
    });

    // Safe JSON parse
    async function safeJson(response, context) {
      try {
        return await response.json();
      } catch (err) {
        const text = await response.text();
        throw new Error(`Risposta non JSON (${context}): ${text}`);
      }
    }

    // Reset
    resetBtn.addEventListener("click", async () => {
      await fetch("/reset", { method:"POST" });
      fileInput.value = "";
      fileList.innerHTML = "";
      preview.innerHTML = "";
      fullTextEl.textContent = "";
      summaryText.textContent = "";
      summarySection.style.display = "none";
      resultsEl.style.display = "none";
      logBox.innerHTML = "";
      logBox.style.display = "none";
      extractedText = "";
      log("Pronto per nuovo upload.");
    });

    decideOCRStrategy();
  </script>
</body>
</html>
