<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistente Referti Medici</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#f0f4f8; margin:2em; color:#333; text-align:center; }
    .container { max-width:900px; margin:auto; background:#fff; padding:2em; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    h1 { color:#007bff; }
    .upload-area { border:2px dashed #ccc; padding:2em; border-radius:10px; margin-top:1em; cursor:pointer; transition:.3s; }
    .upload-area.dragover { border-color:#007bff; background:#f5faff; }
    .results-area { margin-top:2em; text-align:left; }
    pre { background:#eee; padding:1em; border-radius:6px; white-space:pre-wrap; word-wrap:break-word; }
    select, textarea { width:100%; padding:0.8em; margin:1em 0; border-radius:6px; border:1px solid #ccc; font-size:14px; }
    button { padding:12px 24px; margin-top:1em; border:none; border-radius:6px; background:#28a745; color:#fff; font-size:16px; cursor:pointer; }
    button:hover { background:#218838; }
    .loading { color:#007bff; font-weight:bold; margin-top:1em; }
    .log-box { background:#f0f9ff; border-left:4px solid #007bff; padding:1em; margin-top:1em; text-align:left; font-size:14px; border-radius:6px; max-height:200px; overflow-y:auto; }
    .preview { margin-top:1em; max-width:100%; border-radius:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü©∫ Assistente Referti Medici</h1>
    <p>Carica il tuo referto medico (PDF o immagine) e scegli il livello di dettaglio del riassunto.</p>

    <label for="promptSelector"><strong>üîé Tipo di analisi:</strong></label>
    <select id="promptSelector" onchange="toggleCustomPrompt()">
      <option value="simple">Semplice (paziente)</option>
      <option value="intermediate">Intermedio (medico di base)</option>
      <option value="detailed">Dettagliato (specialista)</option>
      <option value="custom">Personalizzato</option>
    </select>
    <textarea id="customPrompt" placeholder="Scrivi qui il tuo prompt personalizzato..." style="display:none;"></textarea>

    <div class="upload-area" id="uploadArea">
      <p><strong>Clicca o trascina qui i tuoi file</strong></p>
      <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" multiple style="display:none;">
    </div>

    <div id="preview"></div>
    <div id="loadingMessage" class="loading" style="display:none;">‚è≥ Elaborazione in corso...</div>
    <div id="logBox" class="log-box" style="display:none;"></div>

    <div id="results" class="results-area" style="display:none;">
      <h2>‚úÖ Riassunto</h2>
      <div id="summaryText"></div>
      <hr>
      <h2>üìÑ Testo Integrale</h2>
      <pre id="fullText"></pre>
      <button id="downloadBtn">üì• Scarica Riassunto (Word)</button>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const uploadArea = document.getElementById("uploadArea");
    const preview = document.getElementById("preview");
    const loadingMessage = document.getElementById("loadingMessage");
    const logBox = document.getElementById("logBox");
    const results = document.getElementById("results");
    const summaryText = document.getElementById("summaryText");
    const fullText = document.getElementById("fullText");
    const downloadBtn = document.getElementById("downloadBtn");

    function log(msg) {
      logBox.innerHTML += `<div>üîπ ${msg}</div>`;
      logBox.style.display = "block";
    }
    function toggleCustomPrompt() {
      document.getElementById("customPrompt").style.display =
        document.getElementById("promptSelector").value === "custom" ? "block" : "none";
    }

    // Drag & Drop
    uploadArea.addEventListener("click", () => fileInput.click());
    uploadArea.addEventListener("dragover", e => { e.preventDefault(); uploadArea.classList.add("dragover"); });
    uploadArea.addEventListener("dragleave", e => { e.preventDefault(); uploadArea.classList.remove("dragover"); });
    uploadArea.addEventListener("drop", e => {
      e.preventDefault();
      uploadArea.classList.remove("dragover");
      fileInput.files = e.dataTransfer.files;
      handleFiles(fileInput.files);
    });
    fileInput.addEventListener("change", () => handleFiles(fileInput.files));

    // Preview
    function handleFiles(files) {
      preview.innerHTML = "";
      for (const file of files) {
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = e => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "preview";
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        } else {
          preview.innerHTML += `<p>üìÑ ${file.name}</p>`;
        }
      }
      decideOCRStrategy(files);
    }

    // Benchmark OCR
    async function benchmarkOCR() {
      const start = performance.now();
      try { await Tesseract.recognize(new Blob([new Uint8Array([0])]), "eng"); } catch {}
      return performance.now() - start;
    }

    async function decideOCRStrategy(files) {
      log("Esecuzione benchmark OCR...");
      const time = await benchmarkOCR();
      log(`‚è± Benchmark: ${time.toFixed(0)} ms`);
      const isMobile = /Mobi|Android/i.test(navigator.userAgent);

      if (!isMobile && time < 1000) {
        log("‚û°Ô∏è Uso OCR lato client");
        runClientOCR(files);
      } else {
        log("‚û°Ô∏è Invio file al server");
        runServerProcessing(files);
      }
    }

    async function runClientOCR(files) {
      loadingMessage.style.display = "block";
      let extractedText = "";
      for (const file of files) {
        if (file.type.startsWith("image/")) {
          log(`OCR client su immagine: ${file.name}`);
          const result = await Tesseract.recognize(file, "ita+eng");
          extractedText += result.data.text + "\n";
        } else {
          log(`File ${file.name} ‚Üí server (no OCR client)`);
          runServerProcessing(files);
          return;
        }
      }
      sendToServer(extractedText);
    }

    async function runServerProcessing(files) {
      loadingMessage.style.display = "block";
      const formData = new FormData();
      for (const file of files) formData.append("file", file);
      const selector = document.getElementById("promptSelector").value;
      const customPrompt = document.getElementById("customPrompt").value;
      formData.append("prompt_type", selector);
      if (selector === "custom") formData.append("custom_prompt", customPrompt);

      try {
        const response = await fetch("/upload", { method: "POST", body: formData });
        const data = await response.json();
        showResults(data);
      } catch (e) { log("‚ùå Errore rete: " + e.message); }
      finally { loadingMessage.style.display = "none"; }
    }

    async function sendToServer(extractedText) {
      const formData = new FormData();
      formData.append("extracted_text", extractedText);
      const selector = document.getElementById("promptSelector").value;
      const customPrompt = document.getElementById("customPrompt").value;
      formData.append("prompt_type", selector);
      if (selector === "custom") formData.append("custom_prompt", customPrompt);

      try {
        const response = await fetch("/upload", { method: "POST", body: formData });
        const data = await response.json();
        showResults(data);
      } catch (e) { log("‚ùå Errore rete: " + e.message); }
      finally { loadingMessage.style.display = "none"; }
    }

    function showResults(data) {
      if (data.status === "success") {
        summaryText.innerHTML = `<div style="background:#e8f5e8;padding:1em;border-radius:6px;">${data.summary}</div>`;
        fullText.textContent = data.full_text;
        results.style.display = "block";
        if (data.page_modes) log(`üìä Modalit√† pagine PDF: ${data.page_modes.join(", ")}`);
        log("‚úÖ Elaborazione completata");
      } else log("‚ùå Errore: " + data.error);
    }

    downloadBtn.addEventListener("click", () => window.location.href = "/download-summary");
  </script>
</body>
</html>
